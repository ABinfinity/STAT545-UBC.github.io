<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="author" content="Shaun Jackman" />

<meta name="date" content="2014-11-03" />

<title>Automating Data-analysis Pipelines</title>

<script src="libs/jquery-1.11.0/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link href="libs/bootstrap-2.3.2/css/united.min.css" rel="stylesheet" />
<link href="libs/bootstrap-2.3.2/css/bootstrap-responsive.min.css" rel="stylesheet" />
<script src="libs/bootstrap-2.3.2/js/bootstrap.min.js"></script>

<style type="text/css">code{white-space: pre;}</style>
<link rel="stylesheet"
      href="libs/highlight/default.css"
      type="text/css" />
<script src="libs/highlight/highlight.js"></script>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs && document.readyState && document.readyState === "complete") {
   window.setTimeout(function() {
      hljs.initHighlighting();
   }, 0);
}
</script>


<link rel="stylesheet" href="libs/local/nav.css" type="text/css" />

</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
</style>
<div class="container-fluid main-container">

<header>
  <div class="nav">
    <a class="nav-logo" href="index.html">
      <img src="static/img/stat545-logo-s.png" width="70px" height="70px"/>
    </a>
    <ul>
      <li class="home"><a href="index.html">Home</a></li>
      <li class="faq"><a href="faq.html">FAQ</a></li>
      <li class="syllabus"><a href="syllabus.html">Syllabus</a></li>
      <li class="topics"><a href="topics.html">Topics</a></li>
      <li class="people"><a href="people.html">People</a></li>
    </ul>
  </div>
</header>

<div id="header">
<h1 class="title">Automating Data-analysis Pipelines</h1>
<h4 class="author"><em>Shaun Jackman</em></h4>
<h4 class="date"><em>2014-11-03</em></h4>
</div>

<div id="TOC">
<ul>
<li><a href="#automating-data-analysis-pipelines">Automating Data-analysis Pipelines</a></li>
<li><a href="#getting-started">Getting Started</a><ul>
<li><a href="#install-make-on-microsoft-windows">Install <code>make</code> on Microsoft Windows</a></li>
<li><a href="#configure-rstudio">Configure RStudio</a></li>
</ul></li>
<li><a href="#dependency-graph-of-the-pipeline">Dependency graph of the pipeline</a></li>
<li><a href="#use-rstudio-to-run-make">Use RStudio to run make</a></li>
<li><a href="#run-make-from-the-command-line">Run make from the command line</a></li>
<li><a href="#download-or-copy-the-dictionary">Download or copy the dictionary</a><ul>
<li><a href="#download-the-dictionary">Download the dictionary</a></li>
<li><a href="#copy-the-dictionary">Copy the dictionary</a></li>
</ul></li>
<li><a href="#create-a-table-of-word-lengths">Create a table of word lengths</a></li>
<li><a href="#plot-a-histogram-of-word-lengths">Plot a histogram of word lengths</a></li>
<li><a href="#render-a-html-report">Render a HTML report</a></li>
<li><a href="#render-a-pdf-report">Render a PDF report</a></li>
<li><a href="#add-a-default-target-to-the-makefile">Add a default target to the Makefile</a></li>
<li><a href="#add-a-clean-target-to-the-makefile">Add a clean target to the Makefile</a></li>
<li><a href="#troubleshooting">Troubleshooting</a><ul>
<li><a href="#missing-separator">Missing separator</a></li>
<li><a href="#rcurlgeturl-get_server_certificate-certificate-verify-failed">RCurl::getURL: GET_SERVER_CERTIFICATE: certificate verify failed</a></li>
</ul></li>
</ul>
</div>

<div id="automating-data-analysis-pipelines" class="section level1">
<h1>Automating Data-analysis Pipelines</h1>
<p>The goal of this activity is to create a pipeline that will</p>
<ul>
<li>calculate a histogram of English word lengths</li>
<li>determine the most common word length</li>
<li>generate a figure of this histogram</li>
<li>render a RMarkdown report in HTML and PDF</li>
</ul>
<p>You will automate this pipeline using <code>make</code>!</p>
</div>
<div id="getting-started" class="section level1">
<h1>Getting Started</h1>
<div id="install-make-on-microsoft-windows" class="section level2">
<h2>Install <code>make</code> on Microsoft Windows</h2>
<p>These instructions are courtesy of <a href="https://github.com/daattali">Dean Attali</a>.</p>
<p>Mac OS and Linux machines come with <code>make</code> installed. You do not need to follow these instructions.</p>
<div id="install-make-for-windows" class="section level3">
<h3>Install Make for Windows</h3>
<ul>
<li>Go to the <a href="http://gnuwin32.sourceforge.net/packages/make.htm">Make for Windows</a> web site</li>
<li>Download the <a href="http://gnuwin32.sourceforge.net/downlinks/make.php">Setup program</a></li>
<li>Install the file you just downloaded and copy to your clipboard the directory in which it is being installed</li>
<li>The default directory is <code>C:\Program Files (x86)\GnuWin32\</code></li>
<li>You now have <code>make</code> installed, but you need to tell Windows where to find the program. This is called <a href="https://www.google.ca/webhp?sourceid=chrome-instant&amp;ion=1&amp;espv=2&amp;ie=UTF-8#q=windows%20update%20path%20variable">updating your <code>PATH</code></a>. You will want to update the <code>PATH</code> to include the <code>bin</code> directory of the newly installed program. These are the steps on Windows 7 (for Windows 8 you’d have to Google it):</li>
</ul>
</div>
<div id="update-your-path" class="section level3">
<h3>Update your <code>PATH</code></h3>
<ul>
<li>Click on the Windows logo</li>
<li>Right click on <em>Computer</em></li>
<li>Select <em>Properties</em></li>
<li>Select <em>Advanced System Settings</em></li>
<li>Select <em>Environment variables</em></li>
<li>Select the line that has the <code>PATH</code> variable. You may have to scroll down to find it</li>
<li>Select <em>Edit</em></li>
<li>Go to the end of the line and add a semicolon <code>;</code>, followed by the path where the program was installed, followed by <code>\bin</code>. For example, I added the following to the end of the line: <code>;C:\Program Files (x86)\GnuWin32\bin</code></li>
<li>Click Okay and close all the windows that you opened</li>
<li>Close RStudio and open it again.</li>
<li>RStudio and your command line will now know where to find <code>make</code></li>
</ul>
</div>
</div>
<div id="configure-rstudio" class="section level2">
<h2>Configure RStudio</h2>
<ul>
<li><code>make</code> is rather picky and requires that lines be indented with tabs and not spaces</li>
<li>Select <em>Tools -&gt; Global Options -&gt; Code Editing</em> and make sure that <em>Insert spaces for tabs</em> is <em>not</em> checked</li>
<li>If <em>Tools -&gt; Project Options</em> is not greyed out, select <em>Tools -&gt; Project Options -&gt; Code Editing</em> and make sure that <em>Insert spaces for tabs</em> is <em>not</em> checked</li>
</ul>
</div>
</div>
<div id="dependency-graph-of-the-pipeline" class="section level1">
<h1>Dependency graph of the pipeline</h1>
<p><a href="block023_pipelines/images/activity.gv"><img src="block023_pipelines/images/activity.png" alt="block023_pipelines/images/activity.png" /></a></p>
</div>
<div id="use-rstudio-to-run-make" class="section level1">
<h1>Use RStudio to run make</h1>
<ul>
<li>Create an RStudio project: <em>File -&gt; New Project</em></li>
<li>Create a new text file: <em>File -&gt; New File -&gt; Text File</em></li>
<li><p>Start editing your first <code>Makefile</code>!</p>
<pre class="makefile"><code>all:
	echo Build all

clean:
	echo Clean all</code></pre></li>
<li>Save it, and name it <code>Makefile</code></li>
<li>Select <em>Build -&gt; Configure Build Tools -&gt; Build Tools -&gt; Project build tools -&gt; Makefile</em></li>
<li>Select <em>Build -&gt; Build All</em></li>
<li><p>The result and any error messages will appear under the <em>Build</em> tab, usually found in the top-right corner of RStudio</p></li>
</ul>
<div id="build-menu-items" class="section level3">
<h3><em>Build</em> menu items</h3>
<ul>
<li><em>Build All</em> runs <code>make all</code></li>
<li><em>Clean and Rebuild</em> runs <code>make clean all</code></li>
<li><em>Clean All</em> runs <code>make clean</code></li>
</ul>
<p>For these menu items to work your <code>Makefile</code> needs to have targets named <code>all</code> and <code>clean</code>. These non-file targets are called phony targets.</p>
</div>
</div>
<div id="run-make-from-the-command-line" class="section level1">
<h1>Run make from the command line</h1>
<ul>
<li>Select <em>Tools -&gt; Shell</em></li>
<li><p>Run</p>
<pre class="sh"><code>make clean
make all
make clean all</code></pre></li>
</ul>
</div>
<div id="download-or-copy-the-dictionary" class="section level1">
<h1>Download or copy the dictionary</h1>
<div id="download-the-dictionary" class="section level2">
<h2>Download the dictionary</h2>
<p>Our first <code>Makefile</code> rule will download the dictionary <code>words.tsv</code>. The command of this rule is a one-line R script, so instead of putting the R script in a separate file, we’ll include the command directly in the Makefile, since it’s so short.</p>
<pre class="makefile"><code>words.tsv:
	Rscript -e &#39;cat(file=&quot;words.tsv&quot;, RCurl::getURL(&quot;https://raw.githubusercontent.com/eneko/data-repository/master/data/words.txt&quot;, ssl.verifypeer=FALSE))&#39;</code></pre>
</div>
<div id="copy-the-dictionary" class="section level2">
<h2>Copy the dictionary</h2>
<p>On Mac or Linux systems, rather than download the dictionary, we can simply copy the file <code>/usr/share/dict/words</code> that comes with the operating system. Windows machines do not have <code>/usr/share/dict/words</code>, and so there we’ll have to download the dictionary.</p>
<pre class="makefile"><code>words.tsv: /usr/share/dict/words
	cp /usr/share/dict/words words.tsv</code></pre>
<p>This rule copies the input file <code>/usr/share/dict/words</code> to create the output file <code>words.tsv</code>. We then repeat these file names in the command rule, which seems rather redundant. We can use the oddly-named variables <code>$&lt;</code> and <code>$@</code>, which represent the input file and output file respectively to save us from this redundancy.</p>
<pre class="makefile"><code>words.tsv: /usr/share/dict/words
	cp $&lt; $@</code></pre>
</div>
</div>
<div id="create-a-table-of-word-lengths" class="section level1">
<h1>Create a table of word lengths</h1>
<p>This rule will read the list of words and generate a table of word length frequency, stored in a tab-separated-values (TSV) file. This R script is a little longer, so we’ll put it in its own file, named <code>histogram.r</code>. If either the script <code>histogram.r</code> or the data file <code>words.tsv</code> were to change, we’d need to rerun this command to get up-to-date results, so both files are dependencies of this rule. The input-file variable <code>$&lt;</code> refers to the <em>first</em> dependency, <code>histogram.r</code>.</p>
<pre class="makefile"><code>histogram.tsv: histogram.r words.tsv
	Rscript $&lt;</code></pre>
<p>Create the R script <code>histogram.r</code> that reads the list of words from <code>words.tsv</code> and writes the table of word length frequency to <code>histogram.tsv</code>. It should be a tab-delimited TSV file with a header and two columns, named <code>Length</code> and <code>Freq</code>. Hint: you can accomplish this task using four functions: <code>read.delim</code>, <code>nchar</code>, <code>table</code> and <code>write.table</code>. Here’s <a href="block023_pipelines/activity/histogram.r">one solution</a>, but try not to peek until you’ve attempted this task yourself.</p>
</div>
<div id="plot-a-histogram-of-word-lengths" class="section level1">
<h1>Plot a histogram of word lengths</h1>
<p>This rule will read the table of word lengths and plot a histogram using qplot. It’s three lines long, but we’ll still include the script in the <code>Makefile</code> directly, and use semicolons <code>;</code> to separate the R commands. The variable <code>$@</code> refers to the output file, <code>histogram.png</code>.</p>
<pre class="makefile"><code>histogram.png: histogram.tsv
	Rscript -e &#39;library(ggplot2); qplot(Length, Freq, data=read.delim(&quot;$&lt;&quot;)); ggsave(&quot;$@&quot;)&#39;</code></pre>
</div>
<div id="render-a-html-report" class="section level1">
<h1>Render a HTML report</h1>
<p>Finally, we’ll use <code>rmarkdown::render</code> to generate the HTML report.</p>
<pre class="makefile"><code>report.html: report.md
	Rscript -e &#39;rmarkdown::render(&quot;$&lt;&quot;)&#39;</code></pre>
<p>If the table of word lengths or figure were to change, <code>make</code> wouldn’t know that it needs to regenerate the report. We can add additional dependencies to the rule so that <code>make</code> will regenerate the report if any of its three dependencies changes.</p>
<pre class="makefile"><code>report.html: report.rmd histogram.tsv histogram.png
	Rscript -e &#39;rmarkdown::render(&quot;$&lt;&quot;)&#39;</code></pre>
<p>Create the RMarkdown file <code>report.rmd</code> that reads the table of words lengths <code>histogram.tsv</code>, reports the most common word length and displays the histogram <code>histogram.png</code>. Here’s <a href="https://raw.githubusercontent.com/STAT545-UBC/STAT545-UBC.github.io/master/block023_pipelines/activity/report.rmd">one solution</a>, but try not to peek until you’ve attempted this task yourself.</p>
</div>
<div id="render-a-pdf-report" class="section level1">
<h1>Render a PDF report</h1>
<p>Can you modify the <code>rmarkdown::render</code> command to generate a PDF report instead of an HTML report? Hint: look at the optional second argument of <code>rmarkdown::render</code>. Alternatively, click the <em>Knit</em> dropdown box and select <em>Knit PDF</em>, and look at how RStudio modifies the header of your RMarkdown script.</p>
</div>
<div id="add-a-default-target-to-the-makefile" class="section level1">
<h1>Add a default target to the Makefile</h1>
<p>The <em>Build -&gt; Build All</em> menu item of RStudio runs the <code>Makefile</code> target named <code>all</code>. To make this default target generate our report, add the report as a dependency of the target named <code>all</code>. Note that unlike other rules, this rule has no commands associated with it.</p>
<pre class="makefile"><code>all: report.html</code></pre>
<p>Select <em>Build -&gt; Build All</em>.</p>
</div>
<div id="add-a-clean-target-to-the-makefile" class="section level1">
<h1>Add a clean target to the Makefile</h1>
<p>The <em>Build -&gt; Clean All</em> menu item of RStudio runs the <code>Makefile</code> target named <code>clean</code>. By convention this target removes all files that can be regenerated by the Makefile.</p>
<pre class="makefile"><code>clean:
	rm -f words.tsv histogram.tsv histogram.png report.html</code></pre>
<p>Select <em>Build -&gt; Clean All</em> and then <em>Build -&gt; Build All</em>.</p>
</div>
<div id="troubleshooting" class="section level1">
<h1>Troubleshooting</h1>
<div id="missing-separator" class="section level2">
<h2>Missing separator</h2>
<p>Error: <code>makefile:2: *** missing separator. Stop.</code></p>
<p>Use tabs instead of spaces to indent command lines.</p>
<p>See <a href="#configure-rstudio">Configure RStudio</a></p>
</div>
<div id="rcurlgeturl-get_server_certificate-certificate-verify-failed" class="section level2">
<h2>RCurl::getURL: GET_SERVER_CERTIFICATE: certificate verify failed</h2>
<p>The secure socket layer (SSL) was unable to make a secure <code>https</code> connection to the remote web site. A work around is to set the <code>ssl.verifypeer=FALSE</code> option of <code>RCurl::getURL</code>. There’s more discussion of this issue on the <a href="http://www.omegahat.org/RCurl/FAQ.html">FAQ for RCurl</a>.</p>
<pre class="r"><code>RCurl::getURL(..., ssl.verifypeer=FALSE)&#39;</code></pre>
<hr />
</div>
</div>

<div class="footer">
This work is licensed under the  <a href="http://creativecommons.org/licenses/by-nc/3.0/">CC BY-NC 3.0 Creative Commons License</a>.
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
$(document).ready(function () {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
});

</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
