<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="author" content="Shaun Jackman" />

<meta name="date" content="2014-11-03" />

<title>Automating Data-analysis Pipelines</title>

<script src="libs/jquery-1.11.0/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link href="libs/bootstrap-2.3.2/css/united.min.css" rel="stylesheet" />
<link href="libs/bootstrap-2.3.2/css/bootstrap-responsive.min.css" rel="stylesheet" />
<script src="libs/bootstrap-2.3.2/js/bootstrap.min.js"></script>

<style type="text/css">code{white-space: pre;}</style>
<link rel="stylesheet"
      href="libs/highlight/default.css"
      type="text/css" />
<script src="libs/highlight/highlight.js"></script>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs && document.readyState && document.readyState === "complete") {
   window.setTimeout(function() {
      hljs.initHighlighting();
   }, 0);
}
</script>


<link rel="stylesheet" href="libs/local/nav.css" type="text/css" />

</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
</style>
<div class="container-fluid main-container">

<header>
  <div class="nav">
    <a class="nav-logo" href="index.html">
      <img src="static/img/stat545-logo-s.png" width="70px" height="70px"/>
    </a>
    <ul>
      <li class="home"><a href="index.html">Home</a></li>
      <li class="faq"><a href="faq.html">FAQ</a></li>
      <li class="syllabus"><a href="syllabus.html">Syllabus</a></li>
      <li class="topics"><a href="topics.html">Topics</a></li>
      <li class="people"><a href="people.html">People</a></li>
    </ul>
  </div>
</header>

<div id="header">
<h1 class="title">Automating Data-analysis Pipelines</h1>
<h4 class="author"><em>Shaun Jackman</em></h4>
<h4 class="date"><em>2014-11-03</em></h4>
</div>

<div id="TOC">
<ul>
<li><a href="#automating-data-analysis-pipelines">Automating Data-analysis Pipelines</a></li>
<li><a href="#dependency-graph-of-the-pipeline">Dependency graph of the pipeline</a></li>
<li><a href="#download-or-copy-the-dictionary">Download or copy the dictionary</a><ul>
<li><a href="#download-the-dictionary">Download the dictionary</a></li>
<li><a href="#copy-the-dictionary">Copy the dictionary</a></li>
</ul></li>
<li><a href="#create-a-table-of-word-lengths">Create a table of word lengths</a></li>
<li><a href="#plot-a-histogram-of-word-lengths">Plot a histogram of word lengths</a></li>
<li><a href="#render-a-html-report">Render a HTML report</a></li>
<li><a href="#render-a-pdf-report">Render a PDF report</a></li>
<li><a href="#add-a-default-target-to-the-makefile">Add a default target to the Makefile</a></li>
<li><a href="#add-a-clean-target-to-the-makefile">Add a clean target to the Makefile</a></li>
</ul>
</div>

<!--
Jenny's proposed re-org and some insertions:

  * dependency graph of the pipeline
  * new RStudio project and Git repo
  * rule to copy and/or download words.txt
  * R script to compute table of word lengths
  * rule to run word length script
  * ?create all and clean targets at this point and play with them?
  * R snippet to create visual histogram
  * rule to create histogram
  * update all and clean targets; use them
  * R Markdown file to generate a report
  * rule to render the Markdown file
  * update all and clean targets; use them
-->

<div id="automating-data-analysis-pipelines" class="section level1">
<h1>Automating Data-analysis Pipelines</h1>
<p>The goal of this activity is to create a pipeline that will</p>
<ul>
<li>calculate a histogram of English word lengths</li>
<li>determine the most common word length</li>
<li>generate a figure of this histogram</li>
<li>render a RMarkdown report in HTML and PDF</li>
</ul>
<p>You will automate this pipeline using <code>make</code>!</p>
</div>
<div id="dependency-graph-of-the-pipeline" class="section level1">
<h1>Dependency graph of the pipeline</h1>
<p><a href="automation01_slides/images/activity.gv"><img src="automation01_slides/images/activity.png" alt="automation01_slides/images/activity.png" /></a></p>
</div>
<div id="download-or-copy-the-dictionary" class="section level1">
<h1>Download or copy the dictionary</h1>
<div id="download-the-dictionary" class="section level2">
<h2>Download the dictionary</h2>
<p>Our first <code>Makefile</code> rule will download the dictionary <code>words.txt</code>. The command of this rule is a one-line R script, so instead of putting the R script in a separate file, we’ll include the command directly in the Makefile, since it’s so short.</p>
<pre class="makefile"><code>words.txt:
	Rscript -e &#39;cat(file=&quot;words.txt&quot;, RCurl::getURL(&quot;https://raw.githubusercontent.com/eneko/data-repository/master/data/words.txt&quot;, ssl.verifypeer=FALSE))&#39;</code></pre>
<p>Troubleshooting: If you see this:</p>
<pre class="sh"><code>RCurl::getURL: GET_SERVER_CERTIFICATE: certificate verify failed</code></pre>
<p>The secure socket layer (SSL) was unable to make a secure <code>https</code> connection to the remote web site. A work around is to set the <code>ssl.verifypeer=FALSE</code> option of <code>RCurl::getURL</code>. There’s more discussion of this issue on the <a href="http://www.omegahat.org/RCurl/FAQ.html">FAQ for RCurl</a>. This is why our suggested <code>RCurl</code> command looks like this:</p>
<pre class="r"><code>RCurl::getURL(..., ssl.verifypeer=FALSE)&#39;</code></pre>
</div>
<div id="copy-the-dictionary" class="section level2">
<h2>Copy the dictionary</h2>
<p>On Mac or Linux systems, rather than download the dictionary, we can simply copy the file <code>/usr/share/dict/words</code> that comes with the operating system. Windows machines do not have <code>/usr/share/dict/words</code>, and so there we’ll have to download the dictionary.</p>
<pre class="makefile"><code>words.txt: /usr/share/dict/words
	cp /usr/share/dict/words words.txt</code></pre>
<p>This rule copies the input file <code>/usr/share/dict/words</code> to create the output file <code>words.txt</code>. We then repeat these file names in the command rule, which seems rather redundant. We can use the oddly-named variables <code>$&lt;</code> and <code>$@</code>, which represent the input file and output file respectively to save us from this redundancy.</p>
<pre class="makefile"><code>words.txt: /usr/share/dict/words
	cp $&lt; $@</code></pre>
</div>
</div>
<div id="create-a-table-of-word-lengths" class="section level1">
<h1>Create a table of word lengths</h1>
<p>This rule will read the list of words and generate a table of word length frequency, stored in a tab-separated-values (TSV) file. This R script is a little longer, so we’ll put it in its own file, named <code>histogram.r</code>. If either the script <code>histogram.r</code> or the data file <code>words.txt</code> were to change, we’d need to rerun this command to get up-to-date results, so both files are dependencies of this rule. The input-file variable <code>$&lt;</code> refers to the <em>first</em> dependency, <code>histogram.r</code>.</p>
<pre class="makefile"><code>histogram.tsv: histogram.r words.txt
	Rscript $&lt;</code></pre>
<p>Create the R script <code>histogram.r</code> that reads the list of words from <code>words.txt</code> and writes the table of word length frequency to <code>histogram.tsv</code>. It should be a tab-delimited TSV file with a header and two columns, named <code>Length</code> and <code>Freq</code>. Hint: you can accomplish this task using four functions: <code>readLines</code>, <code>nchar</code>, <code>table</code> and <code>write.table</code>. Here’s <a href="https://raw.githubusercontent.com/STAT545-UBC/STAT545-UBC.github.io/master/automation10_holding-area/activity/histogram.r">one solution</a>, but try not to peek until you’ve attempted this task yourself.</p>
</div>
<div id="plot-a-histogram-of-word-lengths" class="section level1">
<h1>Plot a histogram of word lengths</h1>
<p>This rule will read the table of word lengths and plot a histogram using qplot. It’s three lines long, but we’ll still include the script in the <code>Makefile</code> directly, and use semicolons <code>;</code> to separate the R commands. The variable <code>$@</code> refers to the output file, <code>histogram.png</code>.</p>
<pre class="makefile"><code>histogram.png: histogram.tsv
	Rscript -e &#39;library(ggplot2); qplot(Length, Freq, data=read.delim(&quot;$&lt;&quot;)); ggsave(&quot;$@&quot;)&#39;</code></pre>
</div>
<div id="render-a-html-report" class="section level1">
<h1>Render a HTML report</h1>
<p>Finally, we’ll use <code>rmarkdown::render</code> to generate the HTML report.</p>
<pre class="makefile"><code>report.html: report.md
	Rscript -e &#39;rmarkdown::render(&quot;$&lt;&quot;)&#39;</code></pre>
<p>If the table of word lengths or figure were to change, <code>make</code> wouldn’t know that it needs to regenerate the report. We can add additional dependencies to the rule so that <code>make</code> will regenerate the report if any of its three dependencies changes.</p>
<pre class="makefile"><code>report.html: report.rmd histogram.tsv histogram.png
	Rscript -e &#39;rmarkdown::render(&quot;$&lt;&quot;)&#39;</code></pre>
<p>Create the RMarkdown file <code>report.rmd</code> that reads the table of words lengths <code>histogram.tsv</code>, reports the most common word length and displays the histogram <code>histogram.png</code>. Here’s <a href="https://raw.githubusercontent.com/STAT545-UBC/STAT545-UBC.github.io/master/automation10_holding-area/activity/report.rmd">one solution</a>, but try not to peek until you’ve attempted this task yourself.</p>
</div>
<div id="render-a-pdf-report" class="section level1">
<h1>Render a PDF report</h1>
<p>Can you modify the <code>rmarkdown::render</code> command to generate a PDF report instead of an HTML report? Hint: look at the optional second argument of <code>rmarkdown::render</code>. Alternatively, click the <em>Knit</em> dropdown box and select <em>Knit PDF</em>, and look at how RStudio modifies the header of your RMarkdown script.</p>
</div>
<div id="add-a-default-target-to-the-makefile" class="section level1">
<h1>Add a default target to the Makefile</h1>
<p>The <em>Build -&gt; Build All</em> menu item of RStudio runs the <code>Makefile</code> target named <code>all</code>. To make this default target generate our report, add the report as a dependency of the target named <code>all</code>. Note that unlike other rules, this rule has no commands associated with it.</p>
<pre class="makefile"><code>all: report.html</code></pre>
<p>Select <em>Build -&gt; Build All</em>.</p>
</div>
<div id="add-a-clean-target-to-the-makefile" class="section level1">
<h1>Add a clean target to the Makefile</h1>
<p>The <em>Build -&gt; Clean All</em> menu item of RStudio runs the <code>Makefile</code> target named <code>clean</code>. By convention this target removes all files that can be regenerated by the Makefile.</p>
<pre class="makefile"><code>clean:
	rm -f words.txt histogram.tsv histogram.png report.html</code></pre>
<p>Select <em>Build -&gt; Clean All</em> and then <em>Build -&gt; Build All</em>.</p>
</div>

<div class="footer">
This work is licensed under the  <a href="http://creativecommons.org/licenses/by-nc/3.0/">CC BY-NC 3.0 Creative Commons License</a>.
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
$(document).ready(function () {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
});

</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
